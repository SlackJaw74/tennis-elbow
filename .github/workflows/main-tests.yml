name: Main Branch Tests

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  all-tests:
    name: All Tests (Unit + UI)
    runs-on: macos-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: List available simulators
        run: xcrun simctl list devices available | grep iPhone
      
      - name: Find available iPhone simulator
        id: find-simulator
        run: |
          # Get the first available iPhone simulator
          SIMULATOR_ID=$(xcrun simctl list devices available iPhone | grep -m 1 "iPhone" | grep -o -E '[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}')
          if [ -z "$SIMULATOR_ID" ]; then
            echo "Error: No iPhone simulator found"
            exit 1
          fi
          echo "Found simulator ID: $SIMULATOR_ID"
          echo "simulator_id=$SIMULATOR_ID" >> $GITHUB_OUTPUT
      
      - name: Install xcpretty for better test output
        run: gem install xcpretty
      
      - name: Run All Tests (Unit + UI)
        id: run-tests
        continue-on-error: true
        run: |
          set -o pipefail
          RESULT_BUNDLE_PATH="TestResults.xcresult"
          xcodebuild test \
            -project "TennisElbow/TennisElbow.xcodeproj" \
            -scheme "TennisElbow" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=${{ steps.find-simulator.outputs.simulator_id }}" \
            -enableCodeCoverage YES \
            -resultBundlePath "$RESULT_BUNDLE_PATH" \
            2>&1 | tee xcodebuild.log | xcpretty --color
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "result=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0
      
      - name: Extract detailed test failure information
        if: steps.run-tests.outputs.result != '0'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ DETAILED TEST FAILURE INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Extract test failures using xcresulttool
          xcrun xcresulttool get --path TestResults.xcresult --format json > test_results.json
          
          # Parse and display failures
          echo "ğŸ” Failed Tests:"
          echo ""
          xcrun xcresulttool get --path TestResults.xcresult --format human
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Fail job if tests failed
        if: steps.run-tests.outputs.result != '0'
        run: exit 1
