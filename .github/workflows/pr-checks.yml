name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: |
          cd TennisElbow
          swiftlint lint --reporter github-actions-logging

  build:
    name: Build
    runs-on: macos-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Build app for simulator
        run: |
          xcodebuild \
            -project "TennisElbow/TennisElbow.xcodeproj" \
            -scheme "TennisElbow" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "generic/platform=iOS Simulator" \
            clean build

  ui-tests:
    name: UI Tests
    runs-on: macos-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: List available simulators
        run: xcrun simctl list devices available | grep iPhone
      
      - name: Find available iPhone simulator
        id: find-simulator
        run: |
          # Get the first available iPhone simulator
          SIMULATOR_ID=$(xcrun simctl list devices available iPhone | grep -m 1 "iPhone" | grep -o -E '\(([A-F0-9-]+)\)' | tr -d '()')
          if [ -z "$SIMULATOR_ID" ]; then
            echo "Error: No iPhone simulator found"
            exit 1
          fi
          echo "Found simulator ID: $SIMULATOR_ID"
          echo "simulator_id=$SIMULATOR_ID" >> $GITHUB_OUTPUT
      
      - name: Run UI Tests
        run: |
          xcodebuild test \
            -project "TennisElbow/TennisElbow.xcodeproj" \
            -scheme "TennisElbow" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,id=${{ steps.find-simulator.outputs.simulator_id }}" \
            -enableCodeCoverage YES

  swiftformat:
    name: SwiftFormat Check
    runs-on: macos-latest
    continue-on-error: true  # Don't fail the build on formatting issues initially
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install SwiftFormat
        run: brew install swiftformat
      
      - name: Run SwiftFormat
        run: |
          cd TennisElbow
          swiftformat .
      
      - name: Check for formatting changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "SwiftFormat made changes. Please run 'make format' locally and commit the changes."
            git diff
            exit 1
          else
            echo "No formatting changes needed."
          fi
