default_platform(:ios)

platform :ios do
  desc "Run the app in iOS Simulator via Makefile"
  lane :simulator do
    sh "make sim-run"
  end

  desc "Archive the app for App Store (requires signing)"
  lane :archive do
    gym(
      scheme: "TennisElbow",
      project: "../TennisElbow/TennisElbow.xcodeproj",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "archives",
      clean: true
    )
  end

  desc "Upload to App Store (credentials required)"
  lane :upload do
    upload_to_app_store(
      skip_binary_upload: false,
      skip_screenshots: true,
      skip_metadata: true
    )
  end

  desc "List available simulators"
  lane :devices do
    sh "make device-list"
  end

  desc "Bump version number - Usage: fastlane bump type:patch|minor|major|build"
  lane :bump do |options|
    type = options[:type] || "patch"
    
    unless ["major", "minor", "patch", "build"].include?(type)
      UI.user_error!("Invalid bump type: #{type}. Use major, minor, patch, or build")
    end
    
    UI.message "üî¢ Bumping #{type} version..."
    sh "../scripts/version_bump.sh", type
    UI.success "‚úì Version bumped successfully!"
  end

  desc "Bump patch version (1.0.0 -> 1.0.1)"
  lane :bump_patch do
    bump(type: "patch")
  end

  desc "Bump minor version (1.0.0 -> 1.1.0)"
  lane :bump_minor do
    bump(type: "minor")
  end

  desc "Bump major version (1.0.0 -> 2.0.0)"
  lane :bump_major do
    bump(type: "major")
  end

  desc "Bump build number only"
  lane :bump_build do
    bump(type: "build")
  end

  desc "Get current version and build number"
  lane :version do
    project_file = "../TennisElbow/TennisElbow.xcodeproj/project.pbxproj"
    version = sh("grep", "-m", "1", "MARKETING_VERSION = ", project_file).split("=").last.strip.gsub(";", "")
    build = sh("grep", "-m", "1", "CURRENT_PROJECT_VERSION = ", project_file).split("=").last.strip.gsub(";", "")
    
    UI.message "üì± Current Version Information:"
    UI.message "   Marketing Version (CFBundleShortVersionString): #{version}"
    UI.message "   Build Number (CFBundleVersion): #{build}"
    UI.message "   Full Version: #{version} (#{build})"
  end

  desc "Generate screenshots for App Store using fastlane snapshot"
  lane :screenshots do
    snapshot(
      project: File.expand_path("../TennisElbow/TennisElbow.xcodeproj", __dir__),
      scheme: "TennisElbow"
    )
  end

  # All supported languages for localized screenshots
  ALL_LANGUAGES = ["en-US", "es-ES", "fr-FR", "de-DE", "ja-JP", "zh-Hans", "pt-PT", "it-IT", "nl-NL", "ko-KR"]
  ENGLISH_ONLY = ["en-US"]

  desc "Capture screenshots for iPhone devices only (English). Use all_languages:true for all languages."
  lane :screenshots_iphone do |options|
    iphone_devices = [
      "iPhone 17 Pro Max",
      "iPhone 17 Pro",
      "iPhone 17",
      "iPhone 16e"
    ]
    languages = options[:all_languages] ? ALL_LANGUAGES : ENGLISH_ONLY
    
    capture_screenshots_for_devices(devices: iphone_devices, device_type: "iPhone", languages: languages)
  end

  desc "Capture screenshots for iPad devices only (English). Use all_languages:true for all languages."
  lane :screenshots_ipad do |options|
    # Updated device list to match available simulators
    ipad_devices = [
      "iPad Pro 13-inch (M5)",
      "iPad Pro 11-inch (M5)",
      "iPad Air 13-inch (M3)",
      "iPad Air 11-inch (M3)"
    ]
    languages = options[:all_languages] ? ALL_LANGUAGES : ENGLISH_ONLY
    
    capture_screenshots_for_devices(devices: ipad_devices, device_type: "iPad", languages: languages)
  end

  desc "Capture screenshots for all devices (English only)"
  lane :screenshots_all do
    UI.message "üì± Capturing screenshots for all devices (English only)..."
    
    UI.message "--- iPhone Devices ---"
    screenshots_iphone(all_languages: false)
    
    UI.message ""
    UI.message "--- iPad Devices ---"
    screenshots_ipad(all_languages: false)
    
    UI.success "‚úÖ Screenshot capture complete for all devices (English)!"
  end

  desc "Capture screenshots for all devices in ALL languages (takes much longer)"
  lane :screenshots_all_languages do
    UI.message "üì± Capturing screenshots for all devices in ALL languages..."
    UI.message "üåç Languages: #{ALL_LANGUAGES.join(', ')}"
    UI.message "‚è±Ô∏è  This will take a while..."
    
    UI.message "--- iPhone Devices ---"
    screenshots_iphone(all_languages: true)
    
    UI.message ""
    UI.message "--- iPad Devices ---"
    screenshots_ipad(all_languages: true)
    
    UI.success "‚úÖ Screenshot capture complete for all devices and languages!"
  end

  desc "Process screenshots for App Store Connect (resize iPhone, copy iPad)"
  lane :process_screenshots do
    languages = ["en-US", "es-ES", "fr-FR", "de-DE", "ja-JP", "zh-Hans", "pt-PT", "it-IT", "nl-NL", "ko-KR"]
    output_dir = "./screenshots/app-store-ready"
    
    # Create output directory
    sh "mkdir -p #{output_dir}"
    
    UI.message "üîÑ Processing screenshots for App Store Connect..."
    UI.message ""
    
    languages.each do |language|
      screenshot_dir = "./screenshots/#{language}"
      
      # Skip if directory doesn't exist
      unless Dir.exist?(screenshot_dir)
        UI.message "‚ö†Ô∏è  Skipping #{language} - directory not found"
        next
      end
      
      lang_output_dir = "#{output_dir}/#{language}"
      sh "mkdir -p #{lang_output_dir}"
      
      UI.message "--- Processing #{language} ---"
      
      # iPhone screenshots - resize to 1284x2778 (6.7" display)
      iphone_target_width = 1284
      iphone_target_height = 2778
      
      UI.message "--- iPhone Screenshots ---"
      Dir.glob("#{screenshot_dir}/iPhone 17 Pro Max-*.png").each do |file|
        filename = File.basename(file)
        new_filename = filename.gsub("iPhone 17 Pro Max-", "iPhone-")
        output_file = "#{lang_output_dir}/#{new_filename}"
        
        UI.message "Processing: #{filename}"
        UI.message "  ‚Üí Resizing to #{iphone_target_width}x#{iphone_target_height}"
        
        sh "sips -z #{iphone_target_height} #{iphone_target_width} '#{file}' --out '#{output_file}' > /dev/null 2>&1"
        
        UI.message "  ‚úì Saved to: #{output_file}"
      end
      
      UI.message ""
      UI.message "--- iPad Screenshots ---"
      # iPad screenshots - copy at original resolution
      Dir.glob("#{screenshot_dir}/iPad*.png").each do |file|
        filename = File.basename(file)
        # Extract device model for better organization
        device_model = filename.match(/^(iPad[^-]*)/)[1] rescue "iPad"
        screenshot_name = filename.match(/-(\d\d-.*)\.png$/)[1] rescue filename
        new_filename = "#{device_model}-#{screenshot_name}"
        output_file = "#{lang_output_dir}/#{new_filename}"
        
        UI.message "Processing: #{filename}"
        UI.message "  ‚Üí Copying original resolution (no resize needed)"
        
        sh "cp '#{file}' '#{output_file}'"
        
        UI.message "  ‚úì Saved to: #{output_file}"
      end
      
      UI.message ""
    end
    
    UI.message ""
    UI.success "‚úÖ Screenshot processing complete!"
    UI.message "üìÅ App Store ready screenshots are in: #{output_dir}"
    UI.message ""
    UI.message "üìã Screenshot Summary:"
    UI.message "   iPhone: #{iphone_target_width} √ó #{iphone_target_height} (6.7\" display)"
    UI.message "   iPad: Original resolution (device-specific sizes)"
    UI.message ""
    UI.message "üí° Use these processed screenshots when uploading to App Store Connect"
  end

  # Private helper lane for capturing screenshots on specific devices
  private_lane :capture_screenshots_for_devices do |options|
    devices = options[:devices]
    device_type = options[:device_type]
    languages = options[:languages] || ENGLISH_ONLY
    
    # Use absolute path for the project
    project_path = File.expand_path("../TennisElbow/TennisElbow.xcodeproj", __dir__)
    scheme = "TennisElbow"
    output_dir = "./screenshots"
    
    UI.message "üì± Capturing screenshots for #{device_type} devices..."
    UI.message "üåç Languages: #{languages.join(', ')}"
    
    begin
      # Use snapshot action which properly sets up SnapshotHelper environment
      snapshot(
        project: project_path,
        scheme: scheme,
        devices: devices,
        languages: languages,
        output_directory: output_dir,
        clear_previous_screenshots: false,
        override_status_bar: true,
        skip_open_summary: true
      )
    rescue => ex
      UI.error "‚ö†Ô∏è  Screenshot capture failed: #{ex.message}"
    end
    
    UI.success "‚úì Completed #{device_type} screenshots"
  end
end
